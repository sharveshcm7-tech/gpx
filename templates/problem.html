{% extends 'base.html' %}
{% block title %}{{ problem.title }} — Grand Prix{% endblock %}
{% block extra_css %}
<style>
.problem-layout{display:grid;grid-template-columns:1fr 480px;gap:0;min-height:calc(100vh - 64px)}
.problem-panel{padding:2rem;overflow-y:auto;border-right:1px solid var(--border)}
.editor-panel{display:flex;flex-direction:column;height:calc(100vh - 64px);position:sticky;top:64px}
.editor-header{background:var(--surface);border-bottom:1px solid var(--border);padding:.75rem 1.25rem;
               display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-shrink:0}
.editor-body{flex:1;position:relative;overflow:hidden}
#monaco-editor{width:100%;height:100%}
.editor-footer{background:var(--surface);border-top:1px solid var(--border);padding:1rem 1.25rem;
               display:flex;gap:.75rem;align-items:center;flex-shrink:0}
.problem-section{margin-bottom:2rem;padding-bottom:2rem;border-bottom:1px solid var(--border)}
.problem-section:last-child{border-bottom:none}
.problem-section-title{font-family:'Orbitron',monospace;font-size:.75rem;letter-spacing:2px;color:var(--muted);
                       text-transform:uppercase;margin-bottom:1rem}
pre{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:1rem;
    font-family:'Share Tech Mono',monospace;font-size:.85rem;overflow-x:auto;white-space:pre-wrap;line-height:1.6}
.sub-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;
          margin-bottom:.5rem;font-size:.85rem}
.verdict-detail{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;
                margin-top:.75rem;font-size:.85rem;display:none}
.verdict-detail.show{display:block}
</style>
{% endblock %}
{% block content %}
<div class="problem-layout">

  <!-- PROBLEM PANEL -->
  <div class="problem-panel">
    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem;flex-wrap:wrap">
      <a href="/dashboard" style="color:var(--muted);font-size:.85rem;text-decoration:none">← Back</a>
      <span class="tag tag-{{ problem.difficulty.lower() }}">{{ problem.difficulty }}</span>
      <span class="badge">{{ problem.category }}</span>
      <span class="badge gold"><i class="fas fa-star"></i> {{ problem.points }} pts</span>
      {% if problem.first_blood_team %}
      <span style="background:rgba(255,23,68,0.15);color:var(--red);border:1px solid rgba(255,23,68,0.3);
                   padding:.2rem .6rem;border-radius:20px;font-size:.7rem;font-weight:700">⚡ FIRST BLOOD TAKEN</span>
      {% endif %}
    </div>
    <h1 style="font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;margin-bottom:2rem">
      {{ problem.title }}
    </h1>

    <div class="problem-section">
      <div class="problem-section-title">Problem Statement</div>
      <div style="line-height:1.8;color:var(--text)">{{ problem.description | replace('\n', '<br>') | safe }}</div>
    </div>

    {% if my_subs %}
    <div class="problem-section">
      <div class="problem-section-title">Your Submissions</div>
      {% for sub in my_subs %}
      <div class="sub-item" style="cursor:pointer" onclick="toggleVerdict({{ loop.index0 }})">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:.75rem;align-items:center">
            <span class="badge {% if sub.status == 'Accepted' %}green{% elif sub.status == 'Pending' %}{% else %}red{% endif %}">
              {{ sub.status }}
            </span>
            <span class="text-muted">{{ sub.language }}</span>
            {% if sub.points_awarded > 0 %}<span class="badge gold">+{{ sub.points_awarded }} pts</span>{% endif %}
          </div>
          <span class="text-muted text-xs">{{ sub.submitted_at }}</span>
        </div>
        {% if sub.admin_note or sub.status != 'Pending' %}
        <div class="verdict-detail" id="verdict-{{ loop.index0 }}">
          {% if sub.admin_note %}<div style="color:var(--muted)"><strong>Admin note:</strong> {{ sub.admin_note }}</div>{% endif %}
          <div style="margin-top:.5rem">
            <button onclick="event.stopPropagation();showCode(`{{ sub.code|replace('`','\\`')|replace('\n','\\n') }}`)" class="btn btn-ghost btn-sm">
              <i class="fas fa-code"></i> View Code
            </button>
          </div>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- EDITOR PANEL -->
  <div class="editor-panel">
    <div class="editor-header">
      <span style="font-family:'Orbitron',monospace;font-size:.75rem;letter-spacing:2px;color:var(--muted)">CODE EDITOR</span>
      <select id="lang-select" class="form-control" style="width:auto;padding:.35rem .75rem;font-size:.85rem">
        <option value="python">Python</option>
        <option value="cpp">C++</option>
        <option value="java">Java</option>
        <option value="javascript">JavaScript</option>
        <option value="c">C</option>
        <option value="go">Go</option>
      </select>
    </div>
    <div class="editor-body">
      <textarea id="code-editor" style="width:100%;height:100%;background:var(--carbon);color:var(--text);
               border:none;outline:none;resize:none;padding:1.5rem;font-family:'Share Tech Mono',monospace;
               font-size:.9rem;line-height:1.7;tab-size:4"
               placeholder="# Write your solution here...
# Example:
def solution():
    pass"></textarea>
    </div>
    <div class="editor-footer">
      <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="submitCode()" id="submit-btn">
        <i class="fas fa-paper-plane"></i> Submit Solution
      </button>
      <button class="btn btn-ghost btn-sm" onclick="clearEditor()">Clear</button>
    </div>
  </div>
</div>

<!-- Code viewer modal -->
<div class="modal-overlay" id="code-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <div class="modal-title">Submitted Code</div>
      <button class="modal-close" onclick="closeModal('code-modal')">✕</button>
    </div>
    <pre id="code-display" style="max-height:500px;overflow-y:auto"></pre>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
// Tab key in textarea
document.getElementById('code-editor').addEventListener('keydown',e=>{
  if(e.key==='Tab'){
    e.preventDefault();
    const s=e.target.selectionStart,end=e.target.selectionEnd;
    e.target.value=e.target.value.substring(0,s)+'    '+e.target.value.substring(end);
    e.target.selectionStart=e.target.selectionEnd=s+4;
  }
});

async function submitCode(){
  const code=document.getElementById('code-editor').value.trim();
  const lang=document.getElementById('lang-select').value;
  if(!code){showToast('Write some code first!','error');return;}
  const btn=document.getElementById('submit-btn');
  btn.textContent='Submitting...';btn.disabled=true;
  try{
    const r=await fetch('/submit',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({problem_id:{{ problem.id }},code,language:lang})
    });
    const d=await r.json();
    if(d.success){
      showToast('Submitted! Awaiting review.','success');
      setTimeout(()=>location.reload(),2000);
    }else{
      showToast(d.error||'Submission failed','error');
    }
  }catch(e){showToast('Network error','error');}
  btn.innerHTML='<i class="fas fa-paper-plane"></i> Submit Solution';btn.disabled=false;
}

function clearEditor(){
  if(confirm('Clear your code?'))document.getElementById('code-editor').value='';
}

function toggleVerdict(idx){
  const el=document.getElementById('verdict-'+idx);
  if(el)el.classList.toggle('show');
}

function showCode(code){
  document.getElementById('code-display').textContent=code.replace(/\\n/g,'\n');
  openModal('code-modal');
}
</script>
{% endblock %}