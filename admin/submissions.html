{% extends 'admin/base_admin.html' %}
{% block title %}Submissions ‚Äî Admin Grand Prix{% endblock %}
{% block admin_content %}
<div class="page-header flex-between">
  <div>
    <div class="page-title">SUBMISSIONS REVIEW</div>
    <div class="page-subtitle">Monitor, grade and manage all submissions</div>
  </div>
  <div style="display:flex;gap:.75rem;align-items:center">
    <span id="auto-refresh-status" class="badge green">‚è± Auto-refresh ON</span>
    <button class="btn btn-outline btn-sm" onclick="toggleAutoRefresh()">Toggle</button>
  </div>
</div>

<!-- FILTERS -->
<div class="card mb-2" style="padding:1rem">
  <form method="GET" style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end">
    <div>
      <label class="form-label">Team</label>
      <input type="text" name="team" class="form-control" placeholder="Team name..." value="{{ team_filter }}" style="width:160px">
    </div>
    <div>
      <label class="form-label">Status</label>
      <select name="status" class="form-control" style="width:160px">
        <option value="">All Status</option>
        <option {% if status_filter=='Pending' %}selected{% endif %}>Pending</option>
        <option {% if status_filter=='Accepted' %}selected{% endif %}>Accepted</option>
        <option {% if status_filter=='Wrong Answer' %}selected{% endif %}>Wrong Answer</option>
        <option {% if status_filter=='Partial' %}selected{% endif %}>Partial</option>
        <option {% if status_filter=='TLE' %}selected{% endif %}>TLE</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
    <a href="/admin/submissions" class="btn btn-ghost btn-sm">Clear</a>
    <div style="margin-left:auto">
      <span class="badge">{{ submissions|length }} results</span>
    </div>
  </form>
</div>

<div class="table-wrap">
  <table id="subs-table">
    <thead>
      <tr><th>ID</th><th>Team</th><th>Problem</th><th>Language</th><th>Status</th><th>Points</th><th>Time</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for sub in submissions %}
      <tr id="row-{{ sub.id }}">
        <td class="font-mono text-xs text-muted">{{ sub.id }}</td>
        <td style="font-weight:700">{{ sub.team_name }}</td>
        <td>{{ sub.problem_title }}</td>
        <td><span class="badge">{{ sub.language }}</span></td>
        <td>
          <span class="badge {% if sub.status=='Accepted' %}green{% elif sub.status=='Pending' %}gold{% elif sub.status=='Partial' %}blue{% else %}red{% endif %}">
            {{ sub.status }}
          </span>
        </td>
        <td style="font-family:'Orbitron',monospace;color:var(--gold)">{{ sub.points_awarded }}</td>
        <td class="text-xs text-muted">{{ sub.submitted_at }}</td>
        <td>
          <div style="display:flex;gap:.3rem">
            <button class="btn btn-sm btn-ghost" onclick="viewSub({{ sub.id }})"><i class="fas fa-code"></i></button>
            <button class="btn btn-sm btn-primary" onclick="openGrade({{ sub.id }}, '{{ sub.problem_title|e }}', '{{ sub.team_name|e }}', '{{ sub.status }}', {{ sub.points_awarded }})">
              Grade
            </button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--muted)">No submissions found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- View Code Modal -->
<div class="modal-overlay" id="view-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <div class="modal-title" id="view-modal-title">Submission Code</div>
      <button class="modal-close" onclick="closeModal('view-modal')">‚úï</button>
    </div>
    <div id="view-meta" style="margin-bottom:1rem;display:flex;gap:.5rem;flex-wrap:wrap"></div>
    <pre id="view-code" style="max-height:450px;overflow-y:auto;font-size:.85rem"></pre>
    <div id="view-note" style="margin-top:1rem;color:var(--muted);font-size:.85rem"></div>
    <div style="margin-top:1rem">
      <button class="btn btn-primary btn-sm" id="grade-from-view">Grade This</button>
    </div>
  </div>
</div>

<!-- Grade Modal -->
<div class="modal-overlay" id="grade-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Grade Submission</div>
      <button class="modal-close" onclick="closeModal('grade-modal')">‚úï</button>
    </div>
    <div id="grade-info" style="margin-bottom:1rem;color:var(--muted);font-size:.9rem"></div>
    <div class="form-group">
      <label class="form-label">Verdict</label>
      <select id="grade-status" class="form-control">
        <option value="Accepted">‚úÖ Accepted</option>
        <option value="Wrong Answer">‚ùå Wrong Answer</option>
        <option value="Partial">üî∂ Partial Credit</option>
        <option value="TLE">‚è±Ô∏è Time Limit Exceeded</option>
        <option value="Pending">‚è≥ Keep Pending</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Points Awarded</label>
      <input type="number" id="grade-points" class="form-control" value="0" min="0">
    </div>
    <div class="form-group">
      <label class="form-label">Admin Note (visible to team)</label>
      <input type="text" id="grade-note" class="form-control" placeholder="Optional feedback...">
    </div>
    <div style="display:flex;gap:.75rem">
      <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="submitGrade()">
        <i class="fas fa-check"></i> Submit Grade
      </button>
      <button class="btn btn-ghost" onclick="closeModal('grade-modal')">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
let currentSid=null;
let autoRefresh=true;
let refreshTimer=null;

function toggleAutoRefresh(){
  autoRefresh=!autoRefresh;
  document.getElementById('auto-refresh-status').textContent=`‚è± Auto-refresh ${autoRefresh?'ON':'OFF'}`;
  document.getElementById('auto-refresh-status').className=`badge ${autoRefresh?'green':'red'}`;
  if(autoRefresh)startRefresh();
  else clearInterval(refreshTimer);
}

function startRefresh(){
  refreshTimer=setInterval(()=>{
    if(!document.querySelector('.modal-overlay.active'))location.reload();
  },30000);
}
startRefresh();

async function viewSub(sid){
  const r=await fetch(`/admin/submissions/${sid}/code`);
  const d=await r.json();
  document.getElementById('view-modal-title').textContent=`#${sid} ‚Äî ${d.problem_title}`;
  document.getElementById('view-code').textContent=d.code||'(empty)';
  document.getElementById('view-meta').innerHTML=`
    <span class="badge ${d.status==='Accepted'?'green':d.status==='Pending'?'gold':'red'}">${d.status}</span>
    <span class="badge">${d.language}</span>
    <span class="badge">${d.team_name}</span>
    <span class="badge">${d.user_name}</span>
  `;
  document.getElementById('view-note').textContent=d.admin_note?'Note: '+d.admin_note:'';
  document.getElementById('grade-from-view').onclick=()=>{
    closeModal('view-modal');
    openGrade(d.id,d.problem_title,d.team_name,d.status,d.points_awarded);
  };
  openModal('view-modal');
}

function openGrade(sid,problem,team,status,points){
  currentSid=sid;
  document.getElementById('grade-info').innerHTML=`<strong>${problem}</strong> ‚Äî Team: <strong>${team}</strong>`;
  document.getElementById('grade-status').value=status||'Pending';
  document.getElementById('grade-points').value=points||0;
  document.getElementById('grade-note').value='';
  openModal('grade-modal');
}

async function submitGrade(){
  const status=document.getElementById('grade-status').value;
  const points=parseInt(document.getElementById('grade-points').value)||0;
  const note=document.getElementById('grade-note').value;
  const r=await fetch(`/admin/submissions/${currentSid}/grade`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({status,points,note})
  });
  const d=await r.json();
  if(d.success){
    showToast('Grade saved!','success');
    closeModal('grade-modal');
    // Update row inline
    const row=document.getElementById('row-'+currentSid);
    if(row){
      const cells=row.querySelectorAll('td');
      const colorMap={'Accepted':'green','Pending':'gold','Partial':'blue'};
      cells[4].innerHTML=`<span class="badge ${colorMap[status]||'red'}">${status}</span>`;
      cells[5].textContent=points;
    }
  }else showToast('Error','error');
}
</script>
{% endblock %}