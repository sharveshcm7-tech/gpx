{% extends 'admin/base_admin.html' %}
{% block title %}Teams — Admin Grand Prix{% endblock %}
{% block admin_content %}
<div class="page-header flex-between">
  <div>
    <div class="page-title">TEAM MANAGEMENT</div>
    <div class="page-subtitle">{{ teams|length }} total teams registered</div>
  </div>
  <div style="display:flex;gap:.5rem">
    <input type="text" id="search-teams" class="form-control" placeholder="Search teams..." style="width:200px" oninput="searchTeams()">
  </div>
</div>

<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem">
  <button class="btn btn-sm btn-primary" onclick="filterTeams('all')">All ({{ teams|length }})</button>
  <button class="btn btn-sm btn-ghost" onclick="filterTeams('pending')">Pending</button>
  <button class="btn btn-sm btn-ghost" onclick="filterTeams('approved')">Approved</button>
  <button class="btn btn-sm btn-ghost" onclick="filterTeams('rejected')">Rejected</button>
</div>

<div class="table-wrap">
  <table id="teams-table">
    <thead>
      <tr><th>ID</th><th>Team Name</th><th>Invite Code</th><th>Members</th><th>Status</th><th>Disqualified</th><th>Registered</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for team in teams %}
      <tr data-status="{{ team.status }}" data-name="{{ team.name.lower() }}">
        <td class="text-muted text-xs font-mono">{{ team.team_id_display or 'N/A' }}</td>
        <td style="font-weight:700">{{ team.name }}</td>
        <td><code style="font-family:'Share Tech Mono',monospace;color:var(--gold);font-size:.85rem">{{ team.invite_code }}</code></td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="viewMembers({{ team.id }},'{{ team.name|e }}')">
            <i class="fas fa-users"></i> {{ team.member_count }}
          </button>
        </td>
        <td>
          <span class="badge {% if team.status=='approved' %}green{% elif team.status=='rejected' %}red{% else %}gold{% endif %}">
            {{ team.status.title() }}
          </span>
        </td>
        <td>
          {% if team.disqualified %}
          <span class="badge red">YES</span>
          {% else %}
          <span class="badge">No</span>
          {% endif %}
        </td>
        <td class="text-xs text-muted">{{ team.created_at }}</td>
        <td>
          <div style="display:flex;gap:.3rem;flex-wrap:wrap">
            {% if team.status == 'pending' %}
            <button class="btn btn-sm btn-success" onclick="teamAction({{ team.id }},'approve')">Approve</button>
            <button class="btn btn-sm btn-danger" onclick="teamAction({{ team.id }},'reject')">Reject</button>
            {% endif %}
            {% if not team.disqualified %}
            <button class="btn btn-sm btn-warning" onclick="teamAction({{ team.id }},'disqualify')">DQ</button>
            {% else %}
            <button class="btn btn-sm btn-ghost" onclick="teamAction({{ team.id }},'reinstate')">Reinstate</button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--muted)">No teams registered yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Members Modal -->
<div class="modal-overlay" id="members-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="members-modal-title">Team Members</div>
      <button class="modal-close" onclick="closeModal('members-modal')">✕</button>
    </div>
    <div id="members-list">Loading...</div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
async function teamAction(tid,action){
  if(['disqualify','reject'].includes(action)&&!confirm('Confirm: '+action+'?'))return;
  const r=await fetch(`/admin/teams/${tid}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})});
  const d=await r.json();
  if(d.success){showToast('Done: '+action,'success');setTimeout(()=>location.reload(),800);}
}

async function viewMembers(tid,tname){
  document.getElementById('members-modal-title').textContent='Members: '+tname;
  document.getElementById('members-list').innerHTML='Loading...';
  openModal('members-modal');
  const r=await fetch(`/admin/teams/${tid}/members`);
  const d=await r.json();
  if(!d.length){document.getElementById('members-list').innerHTML='<p class="text-muted">No members yet.</p>';return;}
  document.getElementById('members-list').innerHTML=d.map(m=>`
    <div style="display:flex;align-items:center;gap:.75rem;padding:.75rem;border-bottom:1px solid var(--border)">
      <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--red),var(--gold));
                  display:flex;align-items:center;justify-content:center;font-weight:700;color:#000">
        ${m.name[0].toUpperCase()}
      </div>
      <div>
        <div style="font-weight:700">${m.name}</div>
        <div class="text-muted text-sm">${m.email}</div>
      </div>
      <div class="text-xs text-muted" style="margin-left:auto">${m.created_at}</div>
    </div>
  `).join('');
}

function filterTeams(status){
  document.querySelectorAll('#teams-table tbody tr').forEach(row=>{
    row.style.display=(status==='all'||row.dataset.status===status)?'':'none';
  });
  document.querySelectorAll('[onclick^="filterTeams"]').forEach(b=>b.className='btn btn-sm btn-ghost');
  event.target.className='btn btn-sm btn-primary';
}

function searchTeams(){
  const q=document.getElementById('search-teams').value.toLowerCase();
  document.querySelectorAll('#teams-table tbody tr').forEach(row=>{
    row.style.display=row.dataset.name.includes(q)?'':'none';
  });
}
</script>
{% endblock %}