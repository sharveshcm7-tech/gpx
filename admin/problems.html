{% extends 'admin/base_admin.html' %}
{% block title %}Problems — Admin Grand Prix{% endblock %}
{% block admin_content %}
<div class="page-header flex-between">
  <div>
    <div class="page-title">PROBLEM MANAGEMENT</div>
    <div class="page-subtitle">{{ problems|length }} problems configured</div>
  </div>
  <div style="display:flex;gap:.75rem">
    <button class="btn btn-outline" onclick="openModal('upload-modal')"><i class="fas fa-upload"></i> Upload CSV</button>
    <button class="btn btn-primary" onclick="openModal('add-modal')"><i class="fas fa-plus"></i> Add Problem</button>
  </div>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr><th>#</th><th>Title</th><th>Difficulty</th><th>Category</th><th>Points</th><th>Visible</th><th>First Blood</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for p in problems %}
      <tr>
        <td class="text-muted text-xs font-mono">{{ p.id }}</td>
        <td style="font-weight:700;max-width:300px">{{ p.title }}</td>
        <td><span class="tag tag-{{ p.difficulty.lower() }}">{{ p.difficulty }}</span></td>
        <td><span class="badge">{{ p.category }}</span></td>
        <td style="font-family:'Orbitron',monospace;color:var(--gold)">{{ p.points }}</td>
        <td>
          <span class="badge {% if p.visible %}green{% else %}red{% endif %}">
            {% if p.visible %}Visible{% else %}Hidden{% endif %}
          </span>
        </td>
        <td>
          {% if p.first_blood_team %}<span style="color:var(--red)">⚡ Taken</span>{% else %}<span class="text-muted">—</span>{% endif %}
        </td>
        <td>
          <div style="display:flex;gap:.4rem">
            <button class="btn btn-sm btn-ghost" onclick='editProblem({{ p.id }},`{{ p.title|e }}`,`{{ p.description|replace("`","'")|e }}`,`{{ p.difficulty }}`,`{{ p.category }}`,{{ p.points }},{{ p.visible }})'>
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteProblem({{ p.id }}, '{{ p.title|e }}')">
              <i class="fas fa-trash"></i>
            </button>
            <button class="btn btn-sm btn-outline" onclick="toggleVisibility({{ p.id }}, {{ 1 if not p.visible else 0 }}, '{{ p.title|e }}')">
              <i class="fas fa-eye{% if p.visible %}-slash{% endif %}"></i>
            </button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" style="text-align:center;padding:3rem;color:var(--muted)">No problems yet. Add your first problem!</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ADD PROBLEM MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add New Problem</div>
      <button class="modal-close" onclick="closeModal('add-modal')">✕</button>
    </div>
    <form id="add-form">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input type="text" name="title" class="form-control" placeholder="Problem title" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description / Statement</label>
        <textarea name="description" class="form-control" rows="8" placeholder="Full problem statement with constraints, sample I/O..."></textarea>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Difficulty</label>
          <select name="difficulty" class="form-control">
            <option value="Easy">Easy</option>
            <option value="Medium" selected>Medium</option>
            <option value="Hard">Hard</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select name="category" class="form-control">
            <option>Arrays</option><option>DP</option><option>Graphs</option>
            <option>Strings</option><option>Greedy</option><option>Trees</option>
            <option>Math</option><option>Sorting</option><option>Binary Search</option><option>Other</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Points</label>
          <input type="number" name="points" class="form-control" value="100" min="1">
        </div>
        <div class="form-group">
          <label class="form-label">Visibility</label>
          <select name="visible" class="form-control">
            <option value="0">Hidden (Draft)</option>
            <option value="1">Visible to Teams</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:.75rem">
        <button type="submit" class="btn btn-primary" style="flex:1;justify-content:center">Add Problem</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('add-modal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT PROBLEM MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Edit Problem</div>
      <button class="modal-close" onclick="closeModal('edit-modal')">✕</button>
    </div>
    <form id="edit-form">
      <input type="hidden" id="edit-id">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input type="text" id="edit-title" class="form-control" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea id="edit-desc" class="form-control" rows="8"></textarea>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Difficulty</label>
          <select id="edit-diff" class="form-control">
            <option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <select id="edit-cat" class="form-control">
            <option>Arrays</option><option>DP</option><option>Graphs</option>
            <option>Strings</option><option>Greedy</option><option>Trees</option>
            <option>Math</option><option>Sorting</option><option>Binary Search</option><option>Other</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Points</label>
          <input type="number" id="edit-points" class="form-control" min="1">
        </div>
        <div class="form-group">
          <label class="form-label">Visible</label>
          <select id="edit-visible" class="form-control">
            <option value="0">Hidden</option><option value="1">Visible</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:.75rem">
        <button type="submit" class="btn btn-primary" style="flex:1;justify-content:center">Save Changes</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('edit-modal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- CSV UPLOAD MODAL -->
<div class="modal-overlay" id="upload-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Upload Problems via CSV</div>
      <button class="modal-close" onclick="closeModal('upload-modal')">✕</button>
    </div>
    <div style="background:var(--surface2);border-radius:10px;padding:1.25rem;margin-bottom:1.25rem;font-size:.85rem">
      <div style="font-weight:700;margin-bottom:.5rem;color:var(--gold)">CSV Format Required:</div>
      <code style="font-family:'Share Tech Mono',monospace;color:var(--muted)">title,description,difficulty,category,points,visible</code>
      <div style="margin-top:.5rem;color:var(--muted)">difficulty: Easy/Medium/Hard | visible: 0/1</div>
    </div>
    <form id="upload-form" enctype="multipart/form-data">
      <div class="form-group">
        <label class="form-label">Select CSV File</label>
        <input type="file" name="file" class="form-control" accept=".csv" required>
      </div>
      <div style="display:flex;gap:.75rem">
        <button type="submit" class="btn btn-primary" style="flex:1;justify-content:center"><i class="fas fa-upload"></i> Upload</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('upload-modal')">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.getElementById('add-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const r=await fetch('/admin/problems/add',{method:'POST',body:fd});
  const d=await r.json();
  if(d.success){showToast('Problem added!','success');closeModal('add-modal');setTimeout(()=>location.reload(),1000);}
  else showToast(d.error||'Error','error');
});

function editProblem(id,title,desc,diff,cat,points,visible){
  document.getElementById('edit-id').value=id;
  document.getElementById('edit-title').value=title;
  document.getElementById('edit-desc').value=desc;
  document.getElementById('edit-diff').value=diff;
  document.getElementById('edit-cat').value=cat;
  document.getElementById('edit-points').value=points;
  document.getElementById('edit-visible').value=visible;
  openModal('edit-modal');
}

document.getElementById('edit-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('edit-id').value;
  const data={
    title:document.getElementById('edit-title').value,
    description:document.getElementById('edit-desc').value,
    difficulty:document.getElementById('edit-diff').value,
    category:document.getElementById('edit-cat').value,
    points:parseInt(document.getElementById('edit-points').value),
    visible:parseInt(document.getElementById('edit-visible').value),
  };
  const r=await fetch(`/admin/problems/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  const d=await r.json();
  if(d.success){showToast('Problem updated!','success');closeModal('edit-modal');setTimeout(()=>location.reload(),1000);}
});

async function deleteProblem(id,title){
  if(!confirm(`Delete "${title}"? This cannot be undone.`))return;
  const r=await fetch(`/admin/problems/${id}`,{method:'DELETE'});
  const d=await r.json();
  if(d.success){showToast('Problem deleted','info');setTimeout(()=>location.reload(),800);}
}

async function toggleVisibility(id,visible,title){
  const r=await fetch(`/admin/problems/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({visible,title,description:'',difficulty:'Medium',category:'Arrays',points:100})});
  // Reload to get current data
  location.reload();
}

document.getElementById('upload-form').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const btn=e.target.querySelector('button[type=submit]');
  btn.textContent='Uploading...';btn.disabled=true;
  const r=await fetch('/admin/problems/upload',{method:'POST',body:fd});
  const d=await r.json();
  if(d.success){showToast(`${d.count} problems imported!`,'success');closeModal('upload-modal');setTimeout(()=>location.reload(),1000);}
  else showToast(d.error||'Upload failed','error');
  btn.textContent='Upload';btn.disabled=false;
});
</script>
{% endblock %}